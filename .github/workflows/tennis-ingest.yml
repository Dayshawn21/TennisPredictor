name: Tennis Ingest

on:
  schedule:
    # Hourly odds refresh (UTC)
    - cron: "10 * * * *"
    # Daily full ingest (UTC) -> 03:00 UTC = 9:00 PM US Central (CST)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      run_mode:
        description: "Which job to run"
        required: true
        default: all
        type: choice
        options:
          - all
          - odds
          - full
      hours_ahead:
        description: "Odds refresh window (hours ahead)"
        required: false
        default: "4"
      start_date:
        description: "START_DATE (YYYY-MM-DD) for full ingest"
        required: false
        default: ""
      end_date:
        description: "END_DATE (YYYY-MM-DD) for full ingest"
        required: false
        default: ""
      tour_filter:
        description: "TOUR_FILTER for full ingest (e.g. ATP,WTA)"
        required: false
        default: ""
      include_wta125:
        description: "INCLUDE_WTA125 for full ingest (0/1)"
        required: false
        default: ""
      odds_sleep_seconds:
        description: "ODDS_SLEEP_SECONDS for full ingest"
        required: false
        default: ""
      ingest_h2h:
        description: "INGEST_H2H for full ingest (0/1)"
        required: false
        default: ""
      ingest_h2h_events:
        description: "INGEST_H2H_EVENTS for full ingest (0/1)"
        required: false
        default: ""

concurrency:
  group: tennis-ingest
  cancel-in-progress: false

jobs:
  odds-refresh:
    name: Odds Refresh
    if: >-
      github.event_name == 'workflow_dispatch' &&
      (inputs.run_mode == 'all' || inputs.run_mode == 'odds') ||
      github.event_name == 'schedule' && github.event.schedule == '10 * * * *'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: api
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Refresh near-start odds
        run: |
          HRS="${{ inputs.hours_ahead }}"
          if [ -z "$HRS" ]; then HRS=4; fi
          python -m scripts.refresh_near_start_odds --hours-ahead "$HRS" --sleep-sec 0.25 --limit 300

  full-ingest:
    name: Full Ingest
    if: >-
      github.event_name == 'workflow_dispatch' &&
      (inputs.run_mode == 'all' || inputs.run_mode == 'full') ||
      github.event_name == 'schedule' && github.event.schedule == '0 3 * * *'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    defaults:
      run:
        working-directory: api
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      INGEST_ODDS: "1"
      ODDS_PROVIDER_ID: "1"
      ODDS_SLEEP_SECONDS: ${{ inputs.odds_sleep_seconds || vars.ODDS_SLEEP_SECONDS || '0.25' }}
      TOUR_FILTER: ${{ inputs.tour_filter || vars.TOUR_FILTER || 'ATP,WTA' }}
      INCLUDE_WTA125: ${{ inputs.include_wta125 || vars.INCLUDE_WTA125 || '1' }}
      AUTO_BACKFILL_CANONICAL: "1"
      AUTO_FILL_ELO: "1"
      AUTO_BACKFILL_H2H: "1"
      INGEST_H2H: ${{ inputs.ingest_h2h || vars.INGEST_H2H || '1' }}
      INGEST_H2H_EVENTS: ${{ inputs.ingest_h2h_events || vars.INGEST_H2H_EVENTS || '1' }}
      START_DATE: ${{ inputs.start_date || vars.START_DATE }}
      END_DATE: ${{ inputs.end_date || vars.END_DATE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Full sofascore ingest
        run: |
          # Optional START_DATE/END_DATE can pin ingest window.
          python -m app.ingest.tennis.sofascore_matchups
